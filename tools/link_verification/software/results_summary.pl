# /usr/bin/perl -w
# results_summary.pl
#
# This script analyzes *_results.txt files containing working/broken link statistics and creates a new file
# with the combined statistics of all files processed in a run.
#
# Input:
# The script searches the directory entered into the first argument of the command line and processes every 
# file matching *_results.txt.
#
# While processing, the script also prints the individual project statistics to the terminal (if the third argument is '1').
#
# Output:
# The final total statistics are then displayed (if the third argument is '1'), along with the start, end and run times of the script, and a file 
# with the name given by the second command line argument is created containing those final statistics.
#
# How to run:
# While in the directory containing this script, run the following command:
# 
# 	perl results_summary.pl <input directory> <output filename>
# For example, while in the following directory: /net/work/software/tools/link_verification/shaam_tool, if you want to run the script on
# the folder /results/, the command would be:
#
# 	perl results_summary.pl /net/work/software/tools/link_verification/shaam_tool/results outputstats.txt
#
# The <input directory> here is the location of the *_results.txt files which will be processed, and the <output filename> is the path and filename of the
# output final stats generated by this script.
# The <output filename> can include a file path if you want the created output file placed somewhere else.
# The third argument is optional, but if you want more detailed progress of the script to be displayed to the terminal, just add any string to the end of 
# the command.
#
# Created by Shaam Patnam
# 2018-06-26

$begintime = time();
$begindate = gmtime();

#Declaring quantity variables
$projects = 0; #number of projects processed
$totalurl = 0; #total urls; working or not
$ftp = 0; #FTP links
$doc = 0; #documents
$workingurl = 0; #working links
$brokenurl = 0; #broken links
$unknownurl = 0; #unknown links
$intsets = 0; #internal CODIAC datasets
$intworkingurl = 0; #working links for CODIAC sets
$intbrokenurl = 0; #broken links for CODIAC sets
@projectlist = (''); #array that will contain names of all projects processed

$toggleprint = $ARGV[2]; #taking the optional third argument as the print statement toggle

#Reading files
$dir = "$ARGV[0]"; #taking directory as first command line arg
if ($toggleprint){
	print "\nReading files in directory: $dir\n\n";
}
foreach $path (glob("$dir/*_results.txt")) { #opening each file in the directory
	open (DATA, "<$path") or die "Couldn't open $path!\n$!";
	if ($toggleprint){
		print "Opened file: $path\n\n";
	}
	$intbrokenurlproj = 0;
	$linecount = 1;
	while (<DATA>){ #reading each line of the file		
		if ($linecount == 1){ #line 1
			@words = split / /, $_;
			chomp $words[5];
			push @projectlist, $words[5];
			if ($toggleprint){
				printf "Processing project $words[5]...\n\n";
				print "Individual project statistics:\n"; #print statement for stats below (after each iteration of while loop)
			}
			$totalurl = $totalurl + $words[2]; #adding 3rd word of line 1 (number of URLs) to total URLs
		}
		if ($linecount == 2){ #line 2
                        @words = split / /, $_;
                        $ftp = $ftp + $words[2]; #adding 3rd word of line 2 to number of FTPs
                }
		if ($linecount == 3){ #line 3
                        @words = split / /, $_;
                        $doc = $doc + $words[2]; #adding 3rd word of line 3 to number of documents
                }
		if ($linecount == 4){ #line 4
                        @words = split / /, $_;
                        $workingurl = $workingurl + $words[2]; #adding 3rd word of line 4 to number of working links
                }
		if ($linecount == 5){ #line 5
                        @words = split / /, $_;
                        $brokenurl = $brokenurl + $words[2]; #adding 3rd word of line 5 to number of broken links
                }
		if ($linecount == 6){ #line 6
                        @words = split / /, $_;
                        $unknownurl = $unknownurl + $words[2]; #adding 3rd word of line 6 to number of unknown links
                }
		if ($linecount == 7){ #line 7
                        @words = split / /, $_;
                        $intsets = $intsets + $words[1]; #adding 2nd word of line 7 to number of internal EOL datasets
			$intworkingurl = $intworkingurl + $words[7]; #adding 8th word of line 7 to number of working internal set links
			if ($words[11] != 0){
				$intbrokenurlproj ++;
			}
			$intbrokenurl = $intbrokenurl + $words[11]; #adding 12th word of line 7 to number of broken internal set links
                }
		if ($toggleprint){
			print "$_"; #printing each line of the file (individual project statistics)
		}

		$linecount++
	}
	if (($intbrokenurlproj != 0)&&($toggleprint)){
		print "WARNING: ";
		print $intbrokenurlproj;
  		print " CODIAC dataset links BROKEN in this project\n";
	}
	close(DATA) or die "Couldn't close file properly";
	$projects ++;
	if ($toggleprint){
		print "\n";
	}
}

#displaying final quantities and percentages
if ($toggleprint){	
	print "FINAL STATISTICS:\n";
	print "Number of projects processed: $projects\n";
	print "Total number of urls: $totalurl\n";
	print "Total number of FTP links: $ftp (";
	printf ("%.2f",($ftp/$totalurl)*100);
	print  "%)\n";
	print "Total number of documents: $doc (";
	printf ("%.2f",($doc/$totalurl)*100);
	print  "%)\n";
	print "Total number of working links: $workingurl (";
	printf ("%.2f",($workingurl/$totalurl)*100);
	print  "%)\n";
	print "Total number of broken links: $brokenurl (";
	printf ("%.2f",($brokenurl/$totalurl)*100);
	print  "%)\n";
	print "Total number of unknown links: $unknownurl (";
	printf ("%.2f",($unknownurl/$totalurl)*100);
	print  "%)\n";
	print "Found a total of $intsets internal EOL CODIAC datasets with $intworkingurl (";
	printf ("%.2f",($intworkingurl/$totalurl)*100);
	print "%) working URLs and $intbrokenurl (";
	printf ("%.2f", ($intbrokenurl/$totalurl)*100);
	print "%) broken URLs\n";
	if ($intbrokenurl != 0){
		print "WARNING: there are a total of $intbrokenurl BROKEN CODIAC dataset links\n\n";
	}
}

# writing to new file
print "\nCreating file...\n";
open (NEW, ">$ARGV[1]");
print {NEW} "Number of projects processed: $projects\n";
print {NEW} "List of projects: ";
for ($i=1; $i < $projects; $i++){
        print {NEW} "$projectlist[$i], ";
}
print {NEW} "$projectlist[$projects]\n";
print {NEW} "Total number of urls: $totalurl\n";
print {NEW} "Total number of FTP links: $ftp (";
printf {NEW} ("%.2f",($ftp/$totalurl)*100);
print {NEW} "%)\n";
print {NEW} "Total number of documents: $doc (";
printf {NEW} ("%.2f",($doc/$totalurl)*100);
print {NEW} "%)\n";
print {NEW} "Total number of working links: $workingurl (";
printf {NEW} ("%.2f",($workingurl/$totalurl)*100);
print {NEW} "%)\n";
print {NEW} "Total number of broken links: $brokenurl (";
printf {NEW} ("%.2f",($brokenurl/$totalurl)*100);
print {NEW} "%)\n";
print {NEW} "Total number of unknown links: $unknownurl (";
printf {NEW} ("%.2f",($unknownurl/$totalurl)*100);
print {NEW} "%)\n";
print {NEW} "Found a total of $intsets internal EOL CODIAC datasets with $intworkingurl (";
printf {NEW} ("%.2f",($intworkingurl/$totalurl)*100);
print {NEW} "%) working URLs and $intbrokenurl (";
printf {NEW} ("%.2f", ($intbrokenurl/$totalurl)*100);
print {NEW} "%) broken URLs\n";


close (NEW);
print "$ARGV[1] created.\n\n";

$enddate = gmtime();
$endtime = time();
$runtime = $endtime - $begintime;
print "Script start time (GMT): $begindate\n";
print "Script end time (GMT): $enddate\n";
print "Runtime: $runtime seconds\n\n";
