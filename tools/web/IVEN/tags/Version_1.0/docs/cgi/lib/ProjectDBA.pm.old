package ProjectDBA;

use strict;
use lib ".";
use Project;
use DatasetDBA;
use ProductDBA;
use Extraction;

sub buildProjectView
{
	my $proj = shift;

	# this slows it down for some reason :(
	my $project = getFromDB( $proj );
	if( !defined( $project ) )
	{
		$project = Project->new();
		$project->{pjname} = $proj;
	}

	#my $project = Project->new();
	#$project->{pjname} = $proj;

	$project->{products} = ProductDBA::getByProject( $proj );

	return $project;
}

sub getAllProjects
{
	my @projects;
	my $sql = "SELECT * FROM projects";
	my $dbh = IvenDB::connect();

	my $sth = $dbh->prepare( $sql );
	$sth->execute();
	while( (my @row = $sth->fetchrow()) )
	{
		my $proj = Project->new();
		$proj->set( \@row );
		$projects[scalar(@projects)] = $proj;
	}

	return \@projects;
}

sub getFromDB
{
	my $pjname = shift;
	my $dbh = IvenDB::connect();
	my $project;

	my $sql = "SELECT * FROM projects WHERE pjname=" . $dbh->quote( $pjname );

	my $sth = $dbh->prepare( $sql );
	$sth->execute();

	my @row = $sth->fetchrow();
	if( @row )
	{
	 	$project = Project->new();
		$project->set( \@row );
	}
	else
	{	
		$project = undef();
	}

	return $project;
}

sub buildThreadView
{
	my $pjname = shift;

	my $project = ProjectDBA::getFromDB( $pjname );

	my $products = ProductDBA::getByProject( $pjname );
	my @no_deps;
	my @trees;
	my $tcount = 0;

	foreach my $pd (@$products)
	{
		my $exts = ExtractionDBA::getByProduct( $pd->{pdname}, $pd->{pjname} );
		if( scalar( @$exts ) == 0 )
		{
			$no_deps[scalar(@no_deps)] = $pd;
		}
		else
		{
			foreach my $ext (@$exts)
			{
				my $child = {};
				my $parent = {};
				$child->{pdname} = $ext->{pdname};
				$child->{child} = undef();
				$parent->{pdname} = $ext->{pdsource};
				$parent->{child} = $child;

				$trees[$tcount++] = $parent;
			}
		}
	}

if( 0 )
{
	my @ntrees;
	my $ntcount = 0;
	$ntrees[$ntcount++] = shift(@trees);
	foreach my $tree (@trees)
	{
		my $success = 0;
		for( my $x = 0; $x < $ntcount; $x++ )
		{
			my $result = addTree( $tree, $ntrees[$x] );	
			if( defined( $result ) )
			{
				$ntrees[$x] = $result;
				$success = 1;
			}
		}

		if( !$success )
		{
			$ntrees[$ntcount++] = $tree;
		}
	}
}
	#$project->{dtrees} = \@ntrees;
	$project->{dtrees} = \@trees;

	return $project;	
}

sub addTree
{
	my $tree1 = shift;
	my $tree2 = shift;

	if( !defined( $tree2 ) )
	{
		return undef;
	}
	elsif( $tree1->{child}->{pdname} eq $tree2->{pdname} ) 
	{
		$tree1->{child} = $tree2;
		return $tree1;
	}
	elsif( $tree2->{child}->{pdname} eq $tree1->{pdname} )
	{
		$tree1->{child}->{child} = $tree2->{child}->{child};
		$tree2->{child} = $tree1;
		return $tree2;
	}
	else
	{
		my $result = addTree( $tree1, $tree2->{child} );
		if( defined( $result ) )
		{
			$tree2->{child} = $result;
			return $tree2;
		}
		else
		{
			return $result;
		}
	}
}

1;
