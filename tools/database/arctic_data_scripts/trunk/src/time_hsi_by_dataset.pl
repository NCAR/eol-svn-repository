#!/usr/bin/perl

#**********************************************************************************#
# time_hsi_by_dataset.pl                                                           #
#                                                                                  #
# Transfers all files in the supplied hsi get file to the appropriate              #
# [dataset_id]/data directory in the current working directory. This file also     #
# times how long file transfers take on the HPSS and outputs data on each transfer #
# to a log file. The transfers must be for a single project using                  #
# get_arctic_data.pl to generate the get commands. Run in the top level directory  #
# for the desired project.                                                         #
#                                                                                  #
# Syntax: time_hsi_by_dataset.pl <list file> <hsi get file for project>            #
#                                                                                  #
# Input:                                                                           #
# list file                                                                        #
#   File generated by running the HSI command ls -P                                #
# hsi get file                                                                     #
#   File generated by running get_arctic_data.pl for a given project               #
#                                                                                  #
# Output:                                                                          #
# hsi_gets_[PID of script].log:                                                    #
#   Contains data on each transfer as it was completed and a summary data table    #
# hsi_times_[PID of script].csv:                                                   #
#   Contains data on each transfer in a comma-separated format.                    #
#                                                                                  #
# 23 Jun 14: time_hsi.pl created by Morgan Garske                                  #
# 26 Jun 14, MG: Script now outputs data to a .csv file each time a transfer       #
#                finishes.                                                         #
# 22 Jul 14, MG: edited time_hsi.pl to now transfer  to dataset_id/data in working #
#                directory                                                         #
# 14 Aug 14, MG: renamed file to time_hsi_by_dataset.pl to be more descriptive.    #
#**********************************************************************************#

use strict;
use List::Util qw(sum);
use constant {
	GIB => 1024**3,
	MIB => 1024**2,
};

if (@ARGV < 2){
	print "Incorrect number of input files.\nUsage: time_hsi_by_dataset.pl <list file> <hsi get file>. \n";
	exit;
}

# Store file sizes for each file listed in the list file
my %file_size;
open HSILST, $ARGV[0] or die "can't open $ARGV[0] $!";
while (<HSILST>){
	if (/^FILE\s([\w\/.-]+)\s(\d+)/) {
		$file_size{$1} = $2;
	}
}
close HSILST;

# Store each get batch listed in the hsi get file 
my $n = -1;
my @gets = ();
open HSIGET, $ARGV[1] or die "can't open $ARGV[1] $!";
while (<HSIGET>) {
	if (/^get <<_([\w.]+)_/){
		$n +=1;
		$gets[$n] = "lcd $1/data\n"; #insert hsi commands to change the local directory to the desired dataset directory before starting transfers
		$gets[$n] .= $_;	
	}
	else {
		$gets[$n] = $gets[$n] . $_;
	}
}
close HSIGET;


# Determine the total filesize and number of files for each batch
my @files;
my %batch_size;
my %number_of_files;
foreach (@gets) {
	@files = split(/\n/m, $_);
	shift @files;
	( $files[0] ) = $files[0] =~ /_([\w.]+)_/;
	foreach (@files) {
		$batch_size{$files[0]} += $file_size{$_};
	}
	$number_of_files{$files[0]} = @files - 2;
}

# Run the get command for each batch on hsi and determine how long each batch takes.
# Meanwhile, output information about each batch to log file
my $start_time;
my $end_time;
my $total_time;
my $localtime;
my @batches = sort keys %batch_size;
my $batch;
my %batch_times;
my %batch_speeds;
$n = 0;
open (my $log, '>', 'hsi_gets_' . $$ . '.log') or die "Could not open log file $!";
open (my $csv, '>', 'hsi_times_' . $$ . '.csv') or die "Could not open .csv file $!";
print $csv "Batch,Number of Files,Size (B),Transfer Time (sec)\n";
foreach (@gets) {
        open (my $fh, '>', 'gets.txt') or die "Could not open gets.txt $!";
        print $fh $_;
        $batch = $batches[$n];
        $n ++;
        print $log "Starting batch $batch at: ";
		print $log `date`;
        printf $log "	$number_of_files{$batch} file(s) totaling %.2f GiB\n", $batch_size{$batch} / GIB;
        $start_time = time;
        system('hsi < gets.txt');
        $end_time = time;
        $batch_times{$batch} = $end_time - $start_time;
        print $log "	Transfer finished in $batch_times{$batch} seconds\n";
        $batch_speeds{$batch} = $batch_size{$batch} / MIB / $batch_times{$batch};
        printf $log "	Transfer speed: %.2f MiB/sec\n", $batch_speeds{$batch};
        $total_time += $end_time - $start_time;
        close $fh;
        print $csv "$batch,$number_of_files{$batch},$batch_size{$batch},$batch_times{$batch}\n";
}
close $csv;

print  $log "\nSummary data:
       |  Number  |  Size  |  Transfer  |    Transfer
 Batch | of Files |  (GiB) | Time (sec) | Speed (MiB/sec)
-------|----------|--------|------------|-----------------\n";
$n = 0;
foreach (@batches) {
	$n ++;
	printf $log "%6s |   %4d   | %6.2f | %10d | %15.2f\n", $_, $number_of_files{$_}, $batch_size{$_} / GIB, $batch_times{$_}, $batch_speeds{$_};
}
print $log "-------|----------|--------|------------|-----------------
 Total |";
my $total_files = sum(values %number_of_files);
my $total_size = sum(values %batch_size) / GIB;
my $average_speed = sum(values %batch_speeds) / @batches;
printf $log "   %4d   | %6.2f | %10d | %15.2f\n", $total_files, $total_size, $total_time, $average_speed;
close $log;

exit;
