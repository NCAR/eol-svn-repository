/*--------------------------------------------------------
 * locate_sigmasq - This module contains that supports
 *   locating the (NEXT) best sigmasq value for the
 *   requested parameter and time.
 *
 *-------------------------------------------------------*/
#include <stdio.h>
#include <stdlib.h>

#include "local.h"
#include "locate_sigmasq.h"
#include "gQC.h"
#include "date.h"

/*-------------------------------------------------------
 * Set DEBUG to 1 for debug type output to screen
 * during any run. Set to 0 to prevent debug output.
 *-------------------------------------------------------*/
#define  DEBUG  0

/*---------------------------------------------------------
 * rewrite_sigmasq_file() - This fn rewrites an existing
 *   sigma_sq (variance) file with updated sigma_sq values.
 *   This fn prevents the HQC s/w from multiple searches
 *   (using locate_sigmasq()) for the same sigma sq value.
 *
 * 29 Sep 95 lec
 *   Created.
 * 01 Nov 95 lec
 *   Updated to use fseek to skip first part of sigmasq 
 *   files.
 *--------------------------------------------------------*/
void rewrite_sigmasq_file( /*in*/ char      sigma_output_file_name[NAMELEN_MAX],
                           /*in*/ int       numstns_inp,
                           /*in*/ STRING27  stn_list[MAXNUMSTNS],
                           /*in*/ float     sigma_sq[MAXNUMSTNS][NUMQCPARMS])
   {
   /* local variables */
   FILE         *sigma_output_stream;

   int          ii,jj, kk = 0;
   int          numstns_in_file = 0;

   char         copy_cmd[NAMELEN_MAX] = "\0";
   char         compression_cmd[NAMELEN_MAX] = "\0";
   long int     offset2, offset3 = 0;
 

#if DEBUG
   printf ("---Enter rewrite_sigmasq_file() ---\n");
   printf ("Rewrite file: xxx%-sxxx\n", sigma_output_file_name);
#endif

   /*------------------------------------------
    * At this point, sigmasq file needs to be
    * uncompressed. Make a copy before update
    * just for save keeping. The copy statement
    * can be deleted in the future.
    *------------------------------------------*/
   sprintf (copy_cmd, "cp %-s.gz %-s.bak.gz\0",           /* Name does not include .gz */
            sigma_output_file_name, sigma_output_file_name);
#if DEBUG
   printf ("executing copy_cmd: %-sxxx\n", copy_cmd);
#endif
   system (copy_cmd);

   sprintf (compression_cmd, "gunzip %-s.gz\0",
            sigma_output_file_name);
#if DEBUG
   printf ("executing compression_cmd: %-sxxx\n", compression_cmd);
#endif
   system (compression_cmd);

   /*--------------------------------------------------
    * Read how many stns are currently listed in
    * this sigma file. If numstns_inp > numstns_in_file
    * then need to update the sig file with the
    * stns encountered on this day. This can occur
    * since we use the previous SIGMA_PERIOD days
    * to compute the next day's variances. If on
    * that next day new stns occur, the compute_
    * sigma program would not have know about them
    * and so would not have added them in to this
    * sigma file. This s/w needs to add them in
    * to prevent future searching.
    *-------------------------------------------------*/
   open_file (sigma_output_file_name, "r+", &sigma_output_stream); /* open for read/write */
   fscanf (sigma_output_stream, "%ld\n", &numstns_in_file); 
 
#if DEBUG    
   printf ("numstns_inp, numstns_in_file: %ld %ld\n", 
           numstns_inp, numstns_in_file);
#endif

   if (numstns_in_file < numstns_inp)
      {
      /*-----------------------------------------------
       * Need to rewrite the every section of the file.
       *-----------------------------------------------*/
      close_file (&sigma_output_stream);
      open_file (sigma_output_file_name, "w", &sigma_output_stream);/* open to write only */

#if DEBUG
      printf ("Must completely rewrite the sigma file!!!\n");
#endif    
	
      fprintf (sigma_output_stream, "%5ld\n", numstns_inp);

      for (ii=0;ii<numstns_inp;ii++)
         fprintf (sigma_output_stream, "%5ld %-27s\n", ii, stn_list[ii]);

      fprintf (sigma_output_stream, "stn_no parm_no  sigma value\n");
      }
   else
      {
      /*------------------------------------------------
       * Just need to update a single variable on one
       * station.
       *-----------------------------------------------*/
      STRIPLINE(sigma_output_stream);
      offset2 = ftell (sigma_output_stream); /* 2 lines down from top */
      STRIPLINE(sigma_output_stream);
      offset3 = ftell (sigma_output_stream); /* 3 lines down from top */

#if DEBUG
      printf ("offset3, offset2, (offset3-offset2): %ld %ld %ld\n",
               offset3, offset2, (offset3-offset2));
#endif

      if (fseek(sigma_output_stream, (numstns_inp-2)*(offset3-offset2), SEEK_CUR) !=0) /*skip 1st section*/
         {
         printf ("Error(1): Problems calling fseek in rewrite_sigmasq()\n");
         exit(1);
         }

      STRIPLINE (sigma_output_stream); /* strip comment line */

#if DEBUG
      printf ("Only need to rewrite last section of sigmasq file.\n");
      printf ("After STRIPLINE - numstns_inp = %d\n", numstns_inp);
#endif

      /*----------------------------------------------
       * C requires that an fseek (or ftell, etc)
       * call be made between switching I/O operations.
       *----------------------------------------------*/
#if DEBUG
      printf ("call fseek\n");
#endif
      if (fseek(sigma_output_stream, 0, SEEK_CUR) !=0) /*go nowhere!*/
         { 
         printf ("Error(2): Problems calling fseek in rewrite_sigmasq()\n");
         exit(1);
         }
      } /* if numstns_in_file < numstns_inp */

   /*----------------------------------------------
    * Write updated sigmasq values to sigmasq file.
    * Only have to rewrite the second half of the
    * file. First half is list of stns should never
    * change.
    *----------------------------------------------*/
   for (ii=0;ii<numstns_inp;ii++)
      {
      for (jj=0;jj<NUMQCPARMS;jj++)
          { 
          if (sigma_sq[ii][jj] > -990.00)
             {
             fprintf (sigma_output_stream, "%5d %5d %f\n", ii, jj, sigma_sq[ii][jj]);
#if DEBUG
             printf ("Write updated sigmasq vals:: %5d %5d %f\n", ii, jj, sigma_sq[ii][jj]);
#endif
             }
          } /* for all parameters jj */
       } /* for all stns (ii) */
 
    close_file (&sigma_output_stream);

    sprintf (compression_cmd, "gzip %-s\0", sigma_output_file_name);
#if DEBUG
    printf ("(End rewrite) executing compression_cmd: %-sxxx\n", compression_cmd);
#endif
    system (compression_cmd);
 
   } /* rewrite_sigmasq_file() */


/*---------------------------------------------------------
 * locate_sigmasq() - This fn searches forward (day by day)
 *   from the input beginning date until it locates the
 *   first non-missing sigmasq value for the input stn,
 *   parameter, and time. This fn will NOT search farther
 *   than SIGMA_PERIOD days, since beyond that many days
 *   seasons might be crossed. If seasons are crossed, the
 *   sigmasq (variance) values may not be valid.
 *
 *   The beginning year, julian date, hour, and minute 
 *   can be extracted from the input sigmasq file name.
 *   
 * 27 Sep 95 lec
 *   Created.
 * 01 Nov 95 lec
 *   Upgraded call since main_qc now uses YYYYJJJ dates.
 *--------------------------------------------------------*/
void locate_sigmasq(/*in*/  char  sigfile_last_searched[NAMELEN_MAX], /* (pathname)YYYYJJJHHMM.sig */
                    /*in*/  char  sigpathname[NAMELEN_MAX], /* Sigmasq file pathname */
                    /*in*/  int   project_end_YYYYJJJ,      /* Year/jdate that project ends */
                    /*in*/  char  input_stn[27],            /* Stn needing sigma_sq value */
                    /*in*/  int   data_type,                /* Type of data being QC'd (temp, etc.) */
                    /*out*/ float *sigma_sq)                /* Variance */
   {
   /* local variables */
   char         next_sigma_file_name[NAMELEN_MAX] = "\0";
   FILE         *next_sigma_file_stream;

   char         sigma_output_file_name[NAMELEN_MAX] = "\0";
   FILE         *sigma_output_stream;

   int          ii,jj, kk = 0;

   int          match_found = FALSE;

   int          path_length = 0;
   int          lesser_stn_length = 0;
   long         stn_no      = -1;
   long         numstns_inp = 0;
   float        best_sigma_sq = -888.880000000;

   char         junkchar;
   char         compression_cmd [NAMELEN_MAX+100];
   char         begin_YYYYJJJ_str[8] = "\0\0\0\0\0\0\0\0";
   char         begin_YYYY_str[5] = "\0\0\0\0\0";

   int          begin_YYYYJJJ;
   int          begin_YYYY;
   int          stop_YYYYJJJ;
   int          current_YYYYJJJ;

   STRING27     stn_list[MAXNUMSTNS];

#if DEBUG
   printf ("---Enter locate_sigmasq---, input_stn:xxx%-sxxx\n", input_stn);
#endif

   /*-----------------------------------------
    * Convert input dates to workable numbers.
    *-----------------------------------------*/
   path_length = strlen (sigpathname);

   strncpy (begin_YYYYJJJ_str, &sigfile_last_searched[path_length], 7);
   begin_YYYYJJJ_str[7] = '\0';

#if DEBUG
   printf ("last date searched: %-s\n", begin_YYYYJJJ_str);
#endif

   begin_YYYYJJJ = atoi (begin_YYYYJJJ_str);
   increment_YYYYJJJ (&begin_YYYYJJJ); /* Begin search at NEXT file */

   strncpy (begin_YYYY_str, &sigfile_last_searched[path_length], 4); 
   begin_YYYY_str[4] = '\0'; 
   begin_YYYY = atoi (begin_YYYY_str);

   stop_YYYYJJJ = add_num_to_YYYYJJJ (begin_YYYYJJJ, SIGMA_PERIOD);

#if DEBUG
   printf ("SEARCH from/to: begin_YYYYJJJ, begin_YYYY, stop_YYYYJJJ, project_end_YYYYJJJ: %d %d %d %d\n",
            begin_YYYYJJJ, begin_YYYY, stop_YYYYJJJ, project_end_YYYYJJJ);
#endif

   /*--------------------------------------------
    * Stop search if any of the following occur:
    *   - Located requested sigmasq.
    *   - Have searched all SIGMA_PERIOD days but
    *     can't find non-missing sigmasq for
    *     requested time.
    *   - Hit end of project, but can't find non-
    *     missing sigmasq for requested time.
    *--------------------------------------------*/
   *sigma_sq = -888.88;

   for( current_YYYYJJJ = begin_YYYYJJJ;  current_YYYYJJJ <= stop_YYYYJJJ;
        increment_YYYYJJJ (&current_YYYYJJJ) )
      {  
#if DEBUG
      printf ("\nCurrent date is: %d\n", current_YYYYJJJ);
#endif

      if (current_YYYYJJJ > project_end_YYYYJJJ) break;

      /*--------------------------------------------------------
       * Open next sigma sq file and search for requested
       * station. If stn not in this file OR requested
       * parameter's sigma not in file, go to next sigmasq file.
       *
       * Note that only the year (YYYY) and julian day (JJJ)
       * change between each file. Not the time or the suffix.
       *-------------------------------------------------------*/
      strcpy (sigma_output_file_name, sigfile_last_searched);

      sprintf (&sigma_output_file_name[path_length], "%7d%-8s", 
               current_YYYYJJJ, &sigfile_last_searched[path_length+7]);

      sprintf (compression_cmd, "gunzip %-s.gz", sigma_output_file_name);

#if  DEBUG
      printf ("excuting cmd:%-sxxx\n", compression_cmd);
#endif
      system (compression_cmd);

      open_file (sigma_output_file_name, "r", &sigma_output_stream);
      fscanf (sigma_output_stream, "%ld\n", &numstns_inp);
 
#if DEBUG
      printf ("numstns_inp: %ld\n", numstns_inp);
#endif
      match_found = 0;

      for (ii=0;ii<numstns_inp;ii++)
         {
         fscanf (sigma_output_stream, "%d%1c", &ii,&junkchar);
         if (feof(sigma_output_stream))
            {
            printf ("ERROR(searching): hit premature End Of File on %-s.\n",
                     sigma_output_file_name);
            exit(1);
            }

         fgets (stn_list[ii], 27, sigma_output_stream);

         if (match_found) continue;

         if (strlen(stn_list[ii]) <= strlen(input_stn))
            lesser_stn_length = strlen(stn_list[ii]);
         else
            lesser_stn_length = strlen(input_stn);

#if DEBUG
         printf ("Comparing stn_list[%d], input_stn: xxx%-sxxx xxx%-sxxx\n",
                  ii, stn_list[ii], input_stn);
#endif
         if (!match_found && !strncmp(stn_list[ii], input_stn, lesser_stn_length))
            {
            /*-------------------------------------
             * Found a match  - don't break! Need 
             * to read to next section of file. 
             *------------------------------------*/
            match_found = 1;
            stn_no = ii;
#if DEBUG
            printf ("   STN FOUND MATCH stn_no, stn_list[%d]:%d xxx%sxxx. Now locate variance.\n", 
                   stn_no, stn_no, stn_list[stn_no]);
#endif
            }
#if DEBUG
         printf ("   stn_list[%d] =  %sxxx\n", ii, stn_list[ii]);
#endif
         }  /* for ii < numstns_inp */

      *sigma_sq = -888.88;

      if (!match_found)
         {
#if DEBUG
         printf ("No stn match was found!\n");
#endif
         stn_no = -999;
         close (sigma_output_stream);
         sprintf (compression_cmd, "gzip %-s\0", sigma_output_file_name);
         system (compression_cmd);
         continue; /* Stn not in the file, go to next file. */
         }

      STRIPLINE (sigma_output_stream); /* Skip the comment line. */
      STRIPLINE (sigma_output_stream); /* Skip the comment line. */

      /*--------------------------------------------------------
       * Can't just STRIPLINES down to where match found,
       * cause sigma file only contains non-missing variances.
       * Just because the stn is listed in the top part of the
       * sigmasq file doesn't mean there will be a non-missing
       * sigmasq value in the second half of that file. It does
       * mean that that stn was encountered at least once when
       * during that time period when compute_sigmasq() was
       * doing the original sigmasq computations.
       *-------------------------------------------------------*/ 
      jj = -999;
      kk = -999;

      while (!feof(sigma_output_stream))
         { 
         fscanf (sigma_output_stream, "%d%d", &jj, &kk);
         if (feof(sigma_output_stream)) break;

         if (jj > stn_no) break;    /* gone too far */
 
         fscanf (sigma_output_stream, "%f", &best_sigma_sq); /* already is a ptr */
         if (feof(sigma_output_stream)) break;

#if DEBUG
         printf ("   jj=%d, kk=%d, best_sigma_sq = %f\n", jj, kk, best_sigma_sq);
#endif
         if (jj < stn_no) continue; /* assumes numbers always in order. */

         if (jj == stn_no && kk == data_type) /* found best sigma_sq!! */
            {
            close_file (&sigma_output_stream);
            sprintf (compression_cmd, "gzip %-s\0", sigma_output_file_name);
            system (compression_cmd);

            *sigma_sq = best_sigma_sq;

            printf ("Found requested sigmasq in file %-s\n", sigma_output_file_name);
#if DEBUG
            printf ("   FOUND *sigma_sq = %f for stn_no=%d, parameter=%d\n", *sigma_sq, jj, kk);
#endif
            return;
            }

         } /* while data in file */

      close_file (&sigma_output_stream);

      sprintf (compression_cmd, "gzip %-s\0", sigma_output_file_name);
      system (compression_cmd);

#if DEBUG
      if (jj == stn_no && kk == data_type)
         printf ("Found requested sigmasq in file %-s\n", sigma_output_file_name);
      else
         printf ("NOTE: SEARCH NEXT SIG FILE - Stn OR parm's variance NOT located in sigfile:: \n   %-s\n",
                  sigma_output_file_name);
#endif

      } /* for current_YYYYJJJ  */

   if (*sigma_sq < -880.00) 
      printf ("Fn locate_sigmasq() could NOT locate requested sigmasq within SIGMA_PERIOD days!!\n");

   }  /* locate_sigmasq() */
